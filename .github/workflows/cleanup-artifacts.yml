name: Cleanup GitHub Artifacts

on:
  # 每周日凌晨3点运行
  schedule:
    - cron: '0 3 * * 0'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to keep artifacts'
        required: false
        default: '15'
        type: string
      keep_recent_count:
        description: 'Number of most recent artifacts to always keep'
        required: false
        default: '3'
        type: string
      dry_run:
        description: 'Dry run mode (only show what would be deleted)'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 设置保留天数
          RETENTION_DAYS=${{ inputs.retention_days || '15' }}
          KEEP_RECENT_COUNT=${{ inputs.keep_recent_count || '3' }}
          DRY_RUN=${{ inputs.dry_run || 'false' }}

          echo "=== DEBUG INFO ==="
          echo "Repository: ${REPO}"
          echo "Retention days: ${RETENTION_DAYS}"
          echo "Keep recent count: ${KEEP_RECENT_COUNT}"
          echo "Dry run mode: ${DRY_RUN}"
          echo "=================="

          # 计算截止日期
          CUTOFF_DATE=$(date -u -d "${RETENTION_DAYS} days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-${RETENTION_DAYS}d +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: ${CUTOFF_DATE}"

          # 获取所有 artifacts (按创建时间降序排序，最新的在前)
          echo "Fetching artifacts..."
          ARTIFACTS=$(gh api repos/${REPO}/actions/artifacts --paginate --jq '.artifacts | sort_by(.created_at) | reverse | .[] | {id: .id, name: .name, created_at: .created_at, size_in_bytes: .size_in_bytes}')

          if [ -z "$ARTIFACTS" ]; then
            echo "No artifacts found"
            exit 0
          fi

          # 创建临时文件存储所有 artifacts
          TEMP_FILE=$(mktemp)
          echo "$ARTIFACTS" > "$TEMP_FILE"

          TOTAL_COUNT=0
          TOTAL_SIZE=0
          DELETE_COUNT=0
          DELETE_SIZE=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          KEEP_COUNT=0
          KEEP_SIZE=0

          # 统计所有 artifacts
          while IFS= read -r artifact; do
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            SIZE=$(echo "$artifact" | jq -r '.size_in_bytes')
            TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
          done < "$TEMP_FILE"

          echo "Total artifacts: ${TOTAL_COUNT}"
          echo "Total size: $(numfmt --to=iec-i --suffix=B ${TOTAL_SIZE} 2>/dev/null || echo "${TOTAL_SIZE} bytes")"
          echo "Will keep at least ${KEEP_RECENT_COUNT} most recent artifacts"

          # 删除过期的 artifacts (但保留最近的 N 个)
          echo ""
          echo "Processing artifacts..."
          INDEX=0
          while IFS= read -r artifact; do
            INDEX=$((INDEX + 1))
            ID=$(echo "$artifact" | jq -r '.id')
            NAME=$(echo "$artifact" | jq -r '.name')
            CREATED=$(echo "$artifact" | jq -r '.created_at')
            SIZE=$(echo "$artifact" | jq -r '.size_in_bytes')

            # 前 N 个(最新的)始终保留
            if [ $INDEX -le $KEEP_RECENT_COUNT ]; then
              echo "Keeping recent artifact #${INDEX}: ${NAME} (created: ${CREATED}, size: $(numfmt --to=iec-i --suffix=B ${SIZE} 2>/dev/null || echo "${SIZE} bytes"))"
              KEEP_COUNT=$((KEEP_COUNT + 1))
              KEEP_SIZE=$((KEEP_SIZE + SIZE))
              continue
            fi

            # 对于其他的 artifacts，检查是否超过保留期
            if [[ "$CREATED" < "$CUTOFF_DATE" ]]; then
              DELETE_COUNT=$((DELETE_COUNT + 1))
              DELETE_SIZE=$((DELETE_SIZE + SIZE))

              if [ "$DRY_RUN" = "true" ]; then
                echo "Would delete artifact: ${NAME} (created: ${CREATED}, size: $(numfmt --to=iec-i --suffix=B ${SIZE} 2>/dev/null || echo "${SIZE} bytes"))"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo -n "Deleting artifact: ${NAME} (created: ${CREATED}, size: $(numfmt --to=iec-i --suffix=B ${SIZE} 2>/dev/null || echo "${SIZE} bytes")) ... "

                # 删除 artifact
                if gh api repos/${REPO}/actions/artifacts/${ID} -X DELETE > /dev/null 2>&1; then
                  echo "OK"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "FAILED"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi

                # 添加延迟避免速率限制
                sleep 0.5
              fi
            else
              echo "Keeping artifact (within retention): ${NAME} (created: ${CREATED}, size: $(numfmt --to=iec-i --suffix=B ${SIZE} 2>/dev/null || echo "${SIZE} bytes"))"
              KEEP_COUNT=$((KEEP_COUNT + 1))
              KEEP_SIZE=$((KEEP_SIZE + SIZE))
            fi
          done < "$TEMP_FILE"

          # 清理临时文件
          rm -f "$TEMP_FILE"

          echo ""
          echo "=== CLEANUP SUMMARY ==="
          if [ "$DRY_RUN" = "true" ]; then
            echo "Mode: DRY RUN (no actual deletions)"
          fi
          echo "Total artifacts: ${TOTAL_COUNT}"
          echo "Total size: $(numfmt --to=iec-i --suffix=B ${TOTAL_SIZE} 2>/dev/null || echo "${TOTAL_SIZE} bytes")"
          echo "Kept artifacts: ${KEEP_COUNT}"
          echo "Kept size: $(numfmt --to=iec-i --suffix=B ${KEEP_SIZE} 2>/dev/null || echo "${KEEP_SIZE} bytes")"
          echo "Artifacts to delete: ${DELETE_COUNT}"
          echo "Size to free: $(numfmt --to=iec-i --suffix=B ${DELETE_SIZE} 2>/dev/null || echo "${DELETE_SIZE} bytes")"
          if [ "$DRY_RUN" = "true" ]; then
            echo "Would delete: ${SUCCESS_COUNT}"
          else
            echo "Successfully deleted: ${SUCCESS_COUNT}"
            if [ $FAILED_COUNT -gt 0 ]; then
              echo "Failed to delete: ${FAILED_COUNT}"
              echo "Warning: Some deletions failed, but continuing..."
            fi
          fi
          echo "Remaining artifacts: $((TOTAL_COUNT - SUCCESS_COUNT))"
          echo "======================="
